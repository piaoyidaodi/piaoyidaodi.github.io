---
layout: post
title: "鸟哥的Linux私房菜--速查III"
categories: Linux
tag: Linux-Note
---
> 鸟哥的Linux私房菜——第十二章至第X章边读边记。

### 12. 正则表达式与文件格式化处理

#### 12.1 正则表达式概述

1. 正则表达式是处理字符串的方法。

2. 避免因为文字编码方式造成的撷取问题，记住以下符号意义：
- `[:alnum:]`，代表英文大小写字母及数字。
- `[:alpha:]`，代表任何英文大小写字母。
- `[:blank:]`，代表空格键与`Tab`键。
- `[:cntrl:]`，代表键盘上的控制按键，包括`CR,LF,Tab`等。
- `[:digit:]`，代表数字。
- `[:graph:]`，除空格符（空格键与`Tab`键）外所有按键。
- `[:lower:]`，代表小写字母。
- `[:print:]`，任何可被打印出的字符。
- `[:punct:]`，代表标点符号，包括`:"'?!;#$`等
- `[:upper:]`，代表大写字母。
- `[:space:]`，代表任何会产生空白的字符，包括空格键、`Tab`、`CR`等。
- `[:xdigit:]`，代表16进制数字类型。

#### 12.2 `grep`进阶

1. `grep [-A] [-B] [--color=auto] '搜寻字符串' 'filename'`：`-A`后加数字表示除了该行外，后续n行也列出来；`-B`后加数字表示除了该行外，前面n行也列出来。

2. 在搜寻的字符串中使用`[]`搜索匹配字符串，**只匹配`[]`中的一个字符**。

3. 如果要求搜寻的字符串中不包含某个字符则使用`[^]`来达成。如`[^g]oo`则不包含`g`。

4. 搜寻部分出现在行首用`^`，如`^the``^[a-z]`，**`^`出现在`[]`内表示反向选择，出现在`[]`外表示行首**。

5. 出现在行尾`$`，`\.$`表示以`.`结尾。

6. `^$`代表空白行。

7. `.`代表一定有一个任意字符的意思，`*`代表重复前一个0到无穷多次的意思，`.*`代表0个或多个任意字符。

8. 限定一定范围内重复字符数使用`{}`，由于此符号在shell中有特殊意义，因此必须使用`\`转义，如`o\{2\}`。

#### 12.3 `sed`工具

1. `sed`属于管线命令，可以分析`standard input`，并进行**取代、删除、新增、撷取**等功能。

2. `sed [-nefri] [动作]`：
- `-n`:使用silent模式。一般`stdin`数据会列出在屏幕上，加上`-n`后，只有经过sed特殊处理的动作才会被列出。
- `-e`:直接在命令行模式下进行`sed`的动作编辑。
- `-f`:直接将`sed`的动作写在一个文件内，`-f filename`则可以执行`filename`内的`sed`动作。
- `-r`:`sed`动作支持延伸性正则表达式语法。（预设是基础正则表达式语法）。
- `-i`:直接修改读取的文件内容，而不是由屏幕输出。

3. 动作说明：`[n1[,n2]]function`。在`n1`到`n2`之间执行动作。
- `a`:新增，`a`的后面可接字符串，字符串会在新的一行出现（目前的下一行）。增加多行时，每一行之间使用\隔开。
- `c`:取代，`c`的后面可接字符串，字符串可取代n1，n2之间的行。
- `d`:删除，后不跟任何东西。
- `i`:插入，`i`的后面可接字符串，字符串会在新的一行出现（目前的上一行）。
- `p`:打印，将某个选择的数据印出。通常p会与参数sed -n一起运作。
- `s`:取代，可直接进行取代。`sed 's/要被取代的字符串/新的字符串/g'`，部分数据的搜寻并取代

4. 格式化打印：printf,大体同C语言。

#### 12.4 `awk`数据处理工具

`awk`工具，用来将一行当中分成**多个字段**来处理，默认字段分隔符为**空格或`Tab`键**。`awk`是**以行为一次处理单位，以字段为最小处理单位**

- `awk '条件类型1{动作1} 条件类型2{动作2}...' filename`
- `awk`可处理后接的文件，也可以读取来自前一个指令的`standard output`。
- `$0`代表整行；`NF`指每一行（`$0`）拥有的字段总数；`NR`指目前`awk`所处理的是第几行数据；`FS`指目前的分割字符，默认是空格。

#### 12.5 文件对比工具

1. `diff [-bBi] from-file to-file`，`diff`比较ASCII纯文本文档的不同（如配置文件）。
- `from-file`：文件名，作为原始比对文件的文件名。
- `to-file`：文件名，作为目标比对文件的文件名。
- `-b`：忽略一行当中，仅有多个空白的差异。（`about me`与`about    me`视为相同）。
- `-B`：忽略空白行的差异。
- `-i`：忽略大小写不同。

2. `cmp [-s] file1 file2`工具对比非纯文本文档，对比字节的区别, `-s`将所有不同点的字节处都列出来，默认`cmp`预设仅输出第一个不同点。

3. `patch`先比较旧版本的差异，并将差异部分制作成补丁文件，再由补丁文件更新旧文件。

### 13. `Shell Scripts`

#### 13.1 零碎

1. Linux系统的服务（services）启动接口是在`/etc/init.d/`目录下。
2. 开机加载程序在`/etc/rc.d/rc.local`中。
3. `shell script`适合用在**系统管理**中，不适合用在处理大量数据上。

#### 13.2 注意事项

1. 编写注意事项
- 指令的执行是从上而下、从左而右的分析不执行;
- 指令、选项与参数间的多个空白都会被忽略掉;
- 空白行也将被忽略掉,而且`tab` 键被视为空格键;
- 如果读到`Enter`(CR) ,就尝试开始执行该行命令;
- 如果一行的内容太多,则可以使用`\`结尾来延伸至下一行;
- `#`可做为注释。

2. 编写习惯
```sh
#!/bin/bash
# Program:
# This program shows "Hello World!" in your screen.
# History:
# 2005/08/23 VBird First release
PATH=/bin:/sbin:/usr/bin:/usr/sbin:/usr/local/bin:/usr/local/sbin:~/bin
export PATH
echo -e "Hello World! \a \n"
exit 0
```
- 第一行`#!/bin/bash`表明使用的shell名称。
- 文档注释。
- 主要环境变量声明，`PATH`和`LANG`可**直接使用该程序下达外部命令，而不用写绝对路径**。
- 程序主体。
- 返回值以告知程序执行结果。该程序执行完后使用`echo $?`，可得该程序执行结果。

3. 文档注释注意事项
- script的功能
- script的版本信息
- script的作者及联系方式
- script的版权信息
- script的更改历史记录
- script内较为特殊的指令，使用**绝对路径**方式下达
- script运行所需的环境变量预先声明和设置

4. 建议使用`var=$((运算内容))`进行运算。

#### 13.3 `script`执行方式差异

1. 使用`source`,`sh script`,`./script`
- 直接或利用`bash``sh`来下达脚本，该script使用一个新的bash环境执行脚本内命令，及**子程序**模式。
- `source`执行脚本，直接在父程序中执行。

2. `test [-efd] filename`：-e是否存在；-f是否存在且为文件；-d是否存在且为目录。更多查询`man test`。

#### 13.4 `Shell`的命令行变量
- `$0`，代表脚本本身的变量名；`$1...`代表后接的变量。
- `$#`，代表后接的参数个数。
- `$@`，代表`"$1""$2"···`，每个变量是独立的，用双引号括起来。
- `$*`，代表`"$1 $2 $3···"`。

#### 13.5 `shift`参数变量偏移
`shift`会移动参数变量，后面可以跟数字，代表前面拿掉几个参数。

### 14. 账号管理

#### 14.1 输入帐号密码，系统做了什么？

1. 先找寻找`/etc/passwd`里面是否有你输入的账号，如果没有则跳出，如果有则将该账号对应的UID与GID(在`/etc/group`中)读出来，另外，该账号的家目录与`shell`设定也一并读出;

2. 接着进入`/etc/shadow`里面找出对应的账号与UID,然后核对输入的密码与里面的密码是否相符；

3. 如果一切都OK,就进入`Shell`。

#### 14.2 `etc/passwd`文件结构
`passwd`使用`:`隔开，共7个字段：
1. 账号名称；

2. 密码：早期系统的密码放在此位置，又因为此文件所有程序都能读取，容易造成密码丢失，该字段后续放入`/etc/shadow`中，会看到一个`x`；

3. UID：
- `0`，代表系统管理员；要让其他账号也有roor权限时，改该帐号UID为`0`即可。
- `1-499`，保留给系统使用的ID ，没有什么特别的地方。
- `500-65535`，给一般使用者使用，目前的linux核心可支持`4294967295(2^32-1)`。

4. GID：与`/etc/group`相关，规范组名与GID的对应，为**初始群组**，用户登入即获得的群组；

5. 用户信息说明栏：解释帐号意义；

6. 家目录；

7. Shell：定义登入系统后使用的Shell，其中`/sbin/nologin`使账号无法取得shell环境的登入动作。

#### 14.3 `etc/shadow`文件结构
`shadow`使用`:`分割，共9个字段：
1. 账号名称：与`/etc/passwd`对应；

2. 密码：加密后的密码；

3. 最近改动密码的日期：以1970.1.1日起以1累加而成的数字；

4. 密码不可被更动的天数（与字段3相比）；

5. 密码需要重新变更的天数（与字段3相比）；

6. 密码需要变更前的警告天数:(与第5字段相比)；

7. 密码过期后的账号宽限时间(密码失效日)：(与第5字段相比)；

8. 账号失效日期；

9. 保留字段。

一般用户忘记密码：使用root身份使用passwd命令处理。

#### 14.4 `etc/group`文件结构
`group`使用`:`分割，共4个字段：
1. 组名；

2. 群组密码；

3. GID；

4. 此群组支持的账号名称：账号想加入某个群组，将该账号填入该字段即可。

#### 14.5 `groups和newgrp`命令

1. `groups`命令，获取当前用户所支持的所有群组。

2. `newgrp`命令，支持切换到已支持的群组。

3. 加入不在的群组，使用`root`利用`usermod`命令加入新群组。

#### 14.6 账户管理

1. `useradd`新建用户：
- `useradd [-u UID][-g 初始群组][-G 次要群组][-mM][-c 说明栏][-d 家目录绝对路径][-r 建立一个系统账号][-s shell] 使用者账号名`新建账户。
- 使用`passwd`为当前账户设置密码。
- `useradd`命令创建时，参考`/etc/default/useradd`中的内容设置用户的基本权限，参考`/etc/login.defs`对UID/GID和密码进行设置。

2. `passwd`设置账户密码
- `passwd [-l][-u][--sdtin][-S 列出密码相关参数][-n 日数][-x 日数][-w 日数][-i 日期] 账号`。
- `[--sdtin]`可透过来自前一个管线的数据，作为密码输入。
- 直接输入`passwd`改变自己密码。
- **`root`不需要旧密码就可以帮助其他用户或自己建立新密码**。

3. `chage`显示详细密码参数
- `chage [-ldEImMW] 账号名`，[-l]列出账号的详细密码参数。

4. `userdel`删除用户相关数据
- `userdel [-r] 用户名`，使用参数[-r]连同家目录一起删除。
- 一般移除一个账号，可通过手动将`/etc/passwd`和`/etc/shadow`里的账号取消即可；如果账号只是暂时不用，将`/etc/shadow`中账号失效日期设置为0即可。

5. 一般用户可用账号查询指令`finger`
- `finger [-s] username`，[-s]列出用户账号、全名等信息。

6. 一般用户`id`指令。

#### 14.7 使用者身份切换
1. `su`切换身份
- `su [-lm][-c] username`，[-]单独使用代表使用login-shell登入系统，若没有则切换为root身份，[-c] 仅执行一次指令。
- 若要完整切换到新使用者的环境，必须要使用`su - username`或`su -l username`，才会连同`PATH/USER/MAIL`等变量都转成新用户环境；如果仅想要执行一次root的命令，可以使用`su --c "命令"`的方式处理；使用`root`切换成为任何使用者时，不需要输入新用户的密码。

2. `sudo`
- 只有在`/etc/sudoers`内的用户才能够执行`sudo`指令。
- `sudo [-b][-u 新使用者账号]`,`[-b]`后续指令放入后台执行，不与当前shell产生影响，`[-u]`预切换账户名，无指定则为`root`。

3. `visudo`与`/etc/sudoers`